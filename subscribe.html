<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscribe - AWS Pricing Calculator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <img src="BellBlazeTech-Logo.png" alt="Logo" class="logo">
    <div class="subscription-container">
        <h1>Subscribe to Premium</h1>
        <p>Get unlimited access to all features</p>
        
        <form id="subscriptionForm" onsubmit="return false;">
            <div class="form-group">
                <label for="name">Full Name*</label>
                <input type="text" id="name" name="name" required readonly>
            </div>
            
            <div class="form-group">
                <label for="email">Email*</label>
                <input type="email" id="email" name="email" required readonly>
            </div>
            
            <div class="form-group">
                <label for="phone">Phone Number*</label>
                <input type="tel" id="phone" name="phone" required>
            </div>
            
            <button type="button" onclick="validateAndSubscribe()" class="proceed-button">Proceed to Payment</button>
        </form>
    </div>

    <script>
        // Load user data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const name = localStorage.getItem("username");
            const email = localStorage.getItem("useremail");
            
            if (name) {
                document.getElementById('name').value = name;
            }
            
            if (email) {
                document.getElementById('email').value = email;
            }
        });
        function validateAndSubscribe() {
            // Get form values
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
    
            if (!phone) {
                alert("Please enter your phone number");
                document.getElementById('phone').focus();
                return;
            } else if (!isValidPhone(phone)) {
                alert("Please enter a valid 10-digit phone number");
                document.getElementById('phone').focus();
                return;
            }
    
            // If all validations pass, proceed to payment
            subscribeNow(name, email, phone);
        }

        // Phone validation helper (for Indian numbers)
        function isValidPhone(phone) {
            const re = /^[6-9]\d{9}$/;
            return re.test(phone);
        }

        function subscribeNow(name, email, phone) {
            // Store current scroll position
            localStorage.setItem('scrollPosition', window.scrollY);

            // Store user details for backend processing
            localStorage.setItem('userphone', phone);
            
            var options = {
                "key": "rzp_live_v6qAzViosoOdnK",
                "amount": 100, // 100 = â‚¹1.00
                "currency": "INR",
                "name": "BellBlaze Technologies",
                "description": "AWS Pricing Calculator Subscription",
                "image": "BellBlazeTech-Logo.png",
                "prefill": {
                    "name": name,
                    "email": email,
                    "contact": phone
                },
                "handler": async function(response) {
                    try {
                        console.log("response: ", response);
                        // First verify the payment with your backend
                        const verificationSuccess = await processPayment({
                            paymentId: response.razorpay_payment_id,
                            name: name,
                            email: email,
                            phone: phone
                        });
                        if (verificationSuccess) {
                            // Update local state
                            handlePaymentSuccess(response);
                            // Then redirect to success page
                            window.location.href = "success.html";
                        } else {
                            alert("Payment verification failed. Please contact support.");
                        }
                    } catch (error) {
                        console.error("Payment processing error:", error);
                        alert("An error occurred during payment processing.");
                    }
                },
                "theme": {
                    "color": "#3399cc"
                }
            };
    
            // Open in new window explicitly
            var rzp1 = new Razorpay(options);
            rzp1.open();
        }

        async function processPayment(paymentData) {
            try {
                console.log("Sending payment data...");
                const response = await fetch('https://jvopmaa40h.execute-api.us-east-1.amazonaws.com/prod/payment/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: "processPayment",
                        paymentId: paymentData.paymentId,
                        name: paymentData.name,
                        email: paymentData.email,
                        phone: paymentData.phone
                    })
                });
                console.log("response status:",response.status);
                console.log("response: ", response);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("API Error Response:", errorText);
                    throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                }

                const responseData = await response.json();
                console.log("Lambda response data:", responseData);
                
                // Handle both possible response formats
                if (typeof responseData === 'string') {
                    const parsedBody = JSON.parse(responseData);
                    return parsedBody.success === true;
                } else {
                    return responseData.success === true;
                }
            } catch (error) {
                console.error("Verification error:", error);
                throw error;
            }
        }

        function handlePaymentSuccess(response) {
            // Store payment details in local storage
            const paymentDetails = {
                razorpay_payment_id: response.razorpay_payment_id,
                payment_date: new Date().toISOString(),
                amount: 100,
                currency: 'INR'
            };
    
            localStorage.setItem("paymentDetails", JSON.stringify(paymentDetails));
            localStorage.setItem("subscribed", "true");
            localStorage.setItem("uploadCount", "0");
            localStorage.setItem("queryCount", "0");
            
            if (typeof checkSubscriptionStatus === 'function') {
                checkSubscriptionStatus();
            }

            // Update UI if needed
            if (typeof updateUsageCounters === 'function') {
                updateUsageCounters();
            }
    
            // Show success message and redirect
            alert("ðŸŽ‰ Thank you for subscribing!");
            window.location.href = "main.html";
        }

        // function updateUsageCounters() {
        //     const isSubscribed = localStorage.getItem("subscribed") === "true";
        //     const uploadCount = localStorage.getItem("uploadCount") || "0";
        //     const queryCount = localStorage.getItem("queryCount") || "0";
    
        //     if (isSubscribed) {
        //         document.getElementById("uploadCountDisplay").textContent = "5";
        //         document.getElementById("queryCountDisplay").textContent = "20";
        //     } else {
        //         document.getElementById("uploadCountDisplay").textContent = uploadCount;
        //         document.getElementById("queryCountDisplay").textContent = queryCount;
        //     }
        //     // saveUserData();
        // }

        function checkSubscriptionStatus() {
            const isSubscribed = localStorage.getItem("subscribed") === "true";
            const subscriptionStatusDiv = document.getElementById('subscriptionStatus');
            const subscribeButtonContainer = document.getElementById('subscribeButtonContainer');
            
            // if (isSubscribed) {
            //     // User is subscribed - show premium status
            //     subscriptionStatusDiv.innerHTML = `
            //         <div class="premium-badge">
            //             <strong>Premium User:</strong> Unlocked More Access
            //         </div>
            //         File Uploads: <span id="uploadCountDisplay">0</span>/5,
            //         Queries used: <span id="queryCountDisplay">0</span>/20
            //     `;
            //     // Hide subscribe button
            //     subscribeButtonContainer.style.display = 'none';
            // } else {
            //     // User is not subscribed - show free tier limits
            //     subscriptionStatusDiv.innerHTML = `
            //         <strong>Free Tier Limits:</strong>
            //         File Uploads: <span id="uploadCountDisplay">0</span>/3,
            //         Queries used: <span id="queryCountDisplay">0</span>/6 
            //     `;
            //     // Show subscribe button
            //     subscribeButtonContainer.style.display = 'block';
            //     // Update counters
            //     updateUsageCounters();
            // }
        }
    </script>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</body>
</html>